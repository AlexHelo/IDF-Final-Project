<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="../webApp/js/store.everything.min.js">
  </script>
  <script src="../webApp/js/jquery-3.3.1.min.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
  <script src="../webApp/js/jquery.mobile.custom.min.js"></script>
  <link rel="stylesheet" href="../webApp/css/homeStyles.css">
  <title>home</title>
</head>

<body>
  <section class="navBar">
    <div class="header">
      <div class="nav-bar">
        <img src="../webApp/images/menu@2x.png" alt="ham menu" class="hamMenu" onclick="openNav()">
        <img src="../webApp/images/knockiLogoBlue.png" alt="logo" id="logo-nav">
      </div>
    </div>
  </section>

  <section class="hamburger-menu" id="mySidenav">
    <img src="../webApp/images/menuClose.png" alt="close icon" class="closebtn" onclick="closeNav()">
    <div class="menu">
      <div class="menu-items">
        <a href="../webApp/home.html">Home</a>
        <a href="../webApp/profile.html">Profile</a>
        <a href="https://twitter.com/knocki?lang=en" target="_blank">Support</a>
        <a href="../webApp/settings.html">Settings</a>
      </div>
    </div>
  </section>

  <section class="myKnockis">
    <div class="title" id="titleMy">
      <h1>MY KNOCKIS</h1>
    </div>
    <div class="knockisHolder" id="registered">
      <div class="holder">
        <div class="detailsKnocki">
          <h1 id="knockiTitle">Knocki</h1>
          <div class="detailsp">
            <p id="knockilocation">Location</p>
            <p id="roomlocation">Room</p>
          </div>
        </div>
      </div>
      <!--button with registered knocki-->
      <a href="../webApp/main.html">
        <div class="holder">
          <div class="detailsKnocki" id="add-new-legend">
            <h1>Add a</h1><br>
            <h1>new</h1><br>
            <h1>Knocki</h1>
            <div class="iconAdd">
              <img src="../webApp/images/addIcon.png" alt="">
            </div>
          </div>
      </a>
    </div>
  </section>

  <section class="editKnocki">
    <section class="knockiVisible">
      <div class="containerKnocki">
        <img src="../webApp/images/backChevron.png" alt="" class="chevronBack" id="chevronBack">
      </div>
      <div class="infoKnocki">
        <div class="Location">
          <div class="detailsContainer">
            <div class="editables">
              <img src="../webApp/images/editIcon.png" alt="" id="editable">
            </div>
            <span id="locEditable" contenteditable="true">Location
            </span>
            <span id="roomEditable" contenteditable="true">Room</span>
            <span id="techEditable">Technology selected</span>
            <span id="patternEditable"></span>
          </div>
          <!--Make editable: document.getElementById("myP").contentEditable = "true";-->
        </div>
      </div>
      <button type="button" name="Done" class="doneSubmit" id="deleteKnocki">Delete Knocki</button>
    </section>
  </section>

  <!-- Edit tech -->
  <section class="selectTech" id="selectTech">
    <div class="instructions" id="instructionsTech">
      <p>Tap into the technology</p>
      <p>you want to set.</p>
    </div>
    <div class="techSections">
      <button type="button" name="button" class="techButton" id="lightbulbButton" data-tech="Light Control">
        <img src="../webApp/images/lightbulbIcon.png" alt="" class="techIcon">
        <div class="description">
          <h1 class="hdescription">Light control.</h1>
          <p class="pdescription">Turn your lights on/off.</p>
        </div>
      </button>
      <!--First (lightbulb) Button ends-->
      <button type="button" name="button" class="techButton" id="phoneButton" data-tech="Find phone">
        <img src="../webApp/images/cellphoneIcon.png" alt="" class="techIcon">
        <div class="description">
          <h1 class="hdescription">Find your phone.</h1>
          <p class="pdescription">Make your phone ring.</p>
        </div>
      </button>
      <!--Cellphone button ends-->
      <button type="button" name="button" class="techButton" id="climateButton" data-tech="Climate control">
        <img src="../webApp/images/temperatureIcon.png" alt="" class="techIcon" id="tempimg">
        <div class="description">
          <h1 class="hdescription">Climate control.</h1>
          <p class="pdescription">Set the desired temperature.</p>
        </div>
      </button>
      <!--Temperature button ends-->
      <button type="button" name="button" class="techButton" id="doorButton" data-tech="Surveillance">
        <img src="../webApp/images/houseIcon.png" alt="" class="techIcon" id="housimg">
        <div class="description">
          <h1 class="hdescription">Surveillance.</h1>
          <p class="pdescription">Know if someone is at the door.</p>
        </div>
      </button>
      <!--Surveillance button ends-->
      <button type="button" name="button" class="techButton" id="alarmButton" data-tech="Manage alarms">
        <img src="../webApp/images/clockIcon.png" alt="" class="techIcon" id="clockimg">
        <div class="description">
          <h1 class="hdescription">Manage Alarms.</h1>
          <p class="pdescription">Set and snooze your alarms.</p>
        </div>
      </button>
      <!--Alarms button ends-->
      <button type="button" name="button" class="techButton" id="coffeeButton" data-tech="Brew coffee">
        <img src="../webApp/images/coffeMakerIcon.png" alt="" class="techIcon" id="coffeimg">
        <div class="description">
          <h1 class="hdescription">Brew Coffee.</h1>
          <p class="pdescription">Start your coffee machine.</p>
        </div>
      </button>
      <!--Coffee button ends-->
      <button type="button" name="button" class="techButton" id="alertsButton" data-tech="Manage alerts">
        <img src="../webApp/images/bellIcon.png" alt="" class="techIcon" id="bellimg">
        <div class="description">
          <h1 class="hdescription">Manage Alerts.</h1>
          <p class="pdescription">Know when your mails and emails arrive.</p>
        </div>
      </button>
      <!--Alerts button ends-->
      <button type="button" name="button" class="techButton" id="playButton" data-tech="Play music">
        <img src="../webApp/images/musicIcon.png" alt="" class="techIcon" id="musicimg">
        <div class="description">
          <h1 class="hdescription">Play your music.</h1>
          <p class="pdescription">Skip, play, pause your music.</p>
        </div>
      </button>
      <!--Music button ends-->
      <button type="button" name="button" class="techButton" id="lampButton" data-tech="Mood control">
        <img src="../webApp/images/lampIcon.png" alt="" class="techIcon" id="lampimg">
        <div class="description">
          <h1 class="hdescription">Mood Control.</h1>
          <p class="pdescription">Dim the lights and play music.</p>
        </div>
      </button>
      <!--Lamp button ends-->
      <button type="button" name="button" class="techButton" id="textingButton" data-tech="Texting">
        <img src="../webApp/images/textingIcon.png" alt="" id="textimg">
        <div class="description">
          <h1 class="hdescription">Texting.</h1>
          <p class="pdescription">Notify when leaving or arriving.</p>
        </div>
      </button>
      <!--TExting button ends-->
    </div>
    <button type="button" name="Done" class="doneSubmit" id="doneTech">Done</button>
  </section>
  <!--end of screen to edit technology-->
  <!-- Start editing pattern screen -->
  <section class="savingGestureScreen">
    <div class="instructionsGesture">
      <div class="title" id="titleTap">
        <h1><span>Letâ€™s record your pattern.</span></h1>
      </div>
      <div class="instructions" id="insTap">
        <p>Please tap for a knock and hold to</p>
        <p>register a silence.</p>
      </div>
    </div>
    <div id="tapArea">

    </div>
    <div id="gestureArea">

    </div>
      <button type="button" name="Done" class="doneSubmit" id="doneRecording">Done</button>
    <div type="button" name="Record" class="greyButton" id="recordAgain"> Record Again </div>
  </section>
  <!-- End editing pattern screen -->
  <script type="text/javascript">
    function openNav() {
      document.getElementById("mySidenav").style.width = "80vw";
    }

    function closeNav() {
      document.getElementById("mySidenav").style.width = "0vw";
    }

    $('.selectTech').hide();

    displayKnockis();
    // Display the knockis
    function displayKnockis() {
      // Empty container
      $('#registered').empty();

      // Loop thorugh all Knockis and add the ones from the logged in user
      for (var i = 1; i <= store.get('tot-knockis'); i++) {
        var s = store.get('knocki-' + i);
        // Check ownership
        if (s.user == store.get('logged-in-user') && s.enabled) {
          $('#registered').append(
            `
            <div class="holder" id="registered" data-id='knocki-${i}'>
              <div class="detailsKnocki">
                <h1 id="knockiTitle">Knocki</h1>
                <div class="detailsp">
                  <p id="knockilocation"> ${s.location}</p>
                  <p id="roomlocation">${s.room}</p>
                </div>
              </div>
            </div>
            `
          );
          
          $("#registered").click(function(){
              // This is the thing that makes the div clickable, 
              // I have no idea why this works, don't mess with powers you cannot control.
          });
        }
      }

      // At the very end add the `Add new knocki button at the bottom.
      $('#registered').append(
        `
      <a href="../webApp/main.html">
      <div class="detailsKnocki" id="add-new-legend">
        <h1>Add a</h1><br>
        <h1>new</h1><br>
        <h1>Knocki</h1>
        <div class="iconAdd">
          <img src="../webApp/images/addIcon.png" alt="">
      </div>
      </a>
      `
      );
    }

    var current_knocki = "";

    var dot = "<div class='dot'></div>";
    var hyphen = "<div class='hyphen'></div>";

    function fillKnockiPattern(pattern) {
      // First we need to divide `k.pattern` into all of the characters so we can read them individually
      var charactersInPattern = pattern.split("");
      for (var i = 0; i < 5; i++) {
        var pattern = ""
        if(charactersInPattern[i] == "d") {
          $('#patternEditable').append(dot);
        } else {
          $('#patternEditable').append(hyphen);
        }
      }
    }
    
    // Add dynamic event listener to knocki
    $('body').on('click', '.holder', function() {
      var k = store.get($(this).data('id'));
      $('#locEditable').html(k.location);
      $('#roomEditable').html(k.room);
      $('#techEditable').html(k.tech);
      fillKnockiPattern(k.pattern);

      $('.myKnockis').hide();
      $('.editKnocki').show();

      $('.selectTech').hide();
      $('.savingAnimationScreen').show();

      // read knocki details and fill page
      current_knocki = $(this).data('id');
      store.set('current_knocki', current_knocki);
    });

    // Hide edit screen and show select tech screen
    $('#techEditable').on('click', function() {
      $('.knockiVisible').hide();
      // Before proceeding to the selection of technology. Update the fields in the `.current_knocki`.
      store.update(current_knocki, function(current_knocki) {
        current_knocki.location = $('#locEditable').html();
        current_knocki.room = $('#roomEditable').html();
      });
      $('.selectTech').show();
    });

    //Hide edit screen and show pattern screen
    $('#patternEditable').on('click', function() {
      $('.knockiVisible').hide();
      // Before proceeding to the selection of technology. Update the fields in the `.current_knocki`.
      store.update(current_knocki, function(current_knocki) {
        current_knocki.location = $('#locEditable').html();
        current_knocki.room = $('#roomEditable').html();
      });
      $('.savingGestureScreen').show();
    });

    $('.containerKnocki').on('click', function() {
      $('.editKnocki').hide();
      // Before proceeding to the selection of technology. Update the fields in the `.current_knocki`.
      store.update(current_knocki, function(current_knocki) {
        current_knocki.location = $('#locEditable').html();
        current_knocki.room = $('#roomEditable').html();
      });
      displayKnockis();
      $('.myKnockis').show();
      $('#patternEditable').html('');
    });

    // give feedback to user when selected and save preference

    $('.techButton').on('click', function() {
      $('.techButton').css('background-color', 'white');
      // Toggle ONLY the selected `key-n` to active
      $(this).css('background-color', '#DEEBF0');
      // Save the selected tech by the user
      var selectedButton = $(this).data('tech');
      selTech = selectedButton;
      // Updates the selected Tech
      store.update(current_knocki, function(current_knocki) {
        current_knocki.tech = selTech;
      });
      $('#techEditable').html(selTech);
    });

    // Goes back to the editing menu
    $('#doneTech').on('click', function() {
      $('.knockiVisible').show();
      $('.myKnockis').hide();
      $('.selectTech').hide();
    });

    // Records taps
    // Enter and save gesture
    var dot = "<div class='dot'></div>";
    var hyphen = "<div class='hyphen'></div>";

    var tot = 1;
    var pattern = "";

    if (store.get('tot-codes') == null) {
      store.set('tot-codes', 0);
    }

    // Call this to check if the patter has been finally recorded.
    function patternRecorded() {
      if (tot == 6) {
        $('#gestureArea').css('background-color', '#a0ed3624');
        $('#doneRecording').css('opacity', 1);
      }
    }

    $('#tapArea').on("tap", function(e) {
      if (tot < 6) {
        e.preventDefault();
        $('#gestureArea').append(dot);
        tot++;
        pattern += "d";
      }
      patternRecorded();
    });

    $("#tapArea").on("taphold", function(e) {
      if (tot < 6) {
        e.preventDefault();
        $('#gestureArea').append(hyphen);
        pattern += "h";
        tot++;
      }
      patternRecorded();
    });

    $('#recordAgain').on('click', function() {
      $('#gestureArea').css('background-color', '#f2f4f5a6');
      $('#doneRecording').css('opacity', 0);
      $('#gestureArea').empty();
      tot=1;
      patternRecorded();
    });

    // Updates pattern in current knocki

    $('#doneRecording').on('click', function() {
      console.log(pattern);
      console.log(current_knocki);
      store.update(current_knocki, function(current_knocki) {
        current_knocki.pattern = pattern;
      });
      $('.savingGestureScreen').hide();
      $('.knockiVisible').show();
      $('#gestureArea').empty();
      tot = 1;
      $('#patternEditable').html('');
      fillKnockiPattern(pattern);
    });

    // Deletes the Knocki
    $('#deleteKnocki').on('click', function() {
      if (confirm("Are you sure you want to delete this Knocki?")) {
        store.update(current_knocki, function(current_knocki) {
          current_knocki.enabled = false;
        });
        displayKnockis();
        $('.editKnocki').hide();
        $('.myKnockis').show();
      } else {

      }
    });

    displayKnockis();
  </script>
</body>

</html>
